<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2 - Stock List Prototype</title>

    <!-- Bootstrap 3.4.1 -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="../assets/styles.css?v=2.0">
    <link rel="stylesheet" href="../assets/offer-bar.css?v=2.0">
    <link rel="stylesheet" href="../assets/offer-drawer.css?v=2.0">
</head>

<body>
    <div id="prototype-nav"></div>
    <div
        style="position:fixed; top:0; right:0; z-index:9999; background:rgba(0,0,0,0.5); color:white; padding:2px 5px; font-size:10px; pointer-events:none;">
        v2.2</div>

    <!-- Header / Navigation (Simplified) -->
    <nav class="navbar navbar-default navbar-static-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">LOGO</a>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">STOCK LIST</a></li>
                    <li><a href="#">AUCTION</a></li>
                    <li><a href="#">PO</a></li>
                    <li><a href="#">GRADING SCALE</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="#">HELP</a></li>
                    <li><a href="#">ACCOUNT <span class="caret"></span></a></li>
                    <li><a href="#">LOGOUT</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container main-content-area">

        <!-- Alerts (Mocked) -->
        <div class="alert alert-warning alert-dismissible" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span
                    aria-hidden="true">&times;</span></button>
            <span class="glyphicon glyphicon-bullhorn" aria-hidden="true"></span>
            1 Auctions open for bidding today. <a href="#" class="alert-link">SEE AUCTIONS</a>
        </div>

        <!-- Toolbar (Mocked) -->
        <!-- Top Action Bar (Import/Export/Cart) Removed per mockup -->

        <!-- Unified Search Header (Toolbar) -->
        <div class="row search-header-row">
            <div class="col-xs-12">
                <div class="stock-list-toolbar">
                    <button class="btn btn-default" type="button" id="filter-toggle-btn" aria-expanded="false"
                        aria-controls="filter-drawer">
                        <span class="material-icons">filter_list</span>
                        <span class="btn-label">Filters</span>
                        <span class="badge filter-count" style="display: none;">0</span>
                    </button>
                    <div class="search-input-wrapper">
                        <input type="text" class="form-control" id="search-input" placeholder="Search Model...">
                        <span id="search-clear" class="material-icons search-clear-icon"
                            style="display: none;">close</span>
                    </div>
                </div>
                <!-- Active Filters Row -->
                <div id="active-filters-container" class="active-filters-row"></div>
            </div>
        </div>

        <div class="drawer-layout-container">
            <!-- Sidebar Drawer -->
            <aside id="filter-drawer" class="sidebar-drawer">
                <div class="drawer-header">
                    <h4 class="drawer-title">Filters</h4>
                    <button type="button" class="close-drawer-btn" id="close-drawer" aria-label="Close">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="drawer-content">
                    <div class="filter-group-toggle">
                        <div class="checkbox-switch">
                            <label>
                                <input type="checkbox" id="filter-oos">
                                <span class="slider round"></span>
                                <span class="label-text">Include Out of Stock</span>
                            </label>
                        </div>
                    </div>

                    <div id="sidebar-filters-container">
                        <!-- Filters injected here by SidebarView -->
                    </div>
                </div>
            </aside>

            <!-- Drawer Backdrop (Mobile only) -->
            <div id="drawer-backdrop" class="drawer-backdrop"></div>

            <!-- Main Results Area -->
            <main class="main-results-area">
                <!-- Stock List Results -->
                <div class="results-header">
                    <div class="results-info">
                        <span id="total-counts" class="text-muted">Loading...</span>
                    </div>
                    <div class="results-controls">
                        <!-- Toggle All Button -->
                        <button class="btn btn-default btn-sm" id="toggle-all-details" style="margin-right: 10px;">
                            <span class="material-icons"
                                style="font-size: 16px; vertical-align: bottom;">unfold_more</span> Expand All
                        </button>
                        <div id="top-pagination"></div>
                    </div>
                </div>

                <div id="stock-list-container">
                    <!-- Product Cards injected here -->
                    <div class="text-center" style="padding: 50px;">
                        <div class="loader"></div>
                        <p class="text-muted" style="margin-top: 10px;">Loading stock data...</p>
                    </div>
                </div>

                <!-- Pagination (Bottom) -->
                <nav aria-label="Page navigation" class="text-center">
                    <ul class="pagination" id="pagination-controls">
                        <!-- Pagination Links -->
                    </ul>
                </nav>
            </main>
        </div>
    </div>

    <!-- Experiment Controls -->


    <!-- Templates (Underscore.js) -->

    <!-- Filters Template -->
    <script type="text/template" id="filter-group-template">
        <div class="filter-group">
            <h4><%= title %></h4>
            <% _.each(items, function(item) { %>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" class="filter-checkbox" data-type="<%= type %>" value="<%= item.label %>"> 
                        <%= item.label %>
                        <span class="filter-count text-muted">(<%= item.count %>)</span>
                    </label>
                </div>
            <% }); %>
        </div>
    </script>

    <!-- Transaction Modal (Buy / Offer) -->
    <div class="modal fade" id="transaction-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header" style="border-bottom: 1px solid #e5e5e5; padding: 15px 20px;">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"
                        style="margin-top: -2px;"><span aria-hidden="true">&times;</span></button>
                    <!-- Rich Header matching Stock List -->
                    <div class="modal-rich-header">
                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                            <span class="product-title" id="modal-item-title"
                                style="font-size: 1.25em; font-weight: 500;">Item Title</span>
                            <span id="modal-offer-status-badge" class="variant-status-badge"
                                style="display:none; margin-left:10px; font-size:11px; padding: 2px 6px;">STATUS</span>
                        </div>
                        <div id="modal-item-badges"
                            style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px;">
                            <!-- Injected Badges (Grades, Warehouse) -->
                        </div>
                    </div>
                </div>
                <div class="modal-body" style="padding: 0;">

                    <!-- Variant Detail Row (Mimics Offer Worksheet) -->
                    <div class="modal-variant-info row"
                        style="margin: 0; padding: 12px 20px; background-color: #fcfcfc; border-bottom: 1px solid #eee; display: flex; align-items: center;">
                        <div class="col-xs-8" style="padding-left: 0;">
                            <div style="font-weight: 500; font-size: 0.95em; color: #333;" id="modal-variant-desc">Color
                                (Network)</div>
                            <div style="font-family: monospace; font-size: 0.85em; color: #8BA1A7; margin-top: 2px;"
                                id="modal-item-sku">SKU</div>
                        </div>
                        <div class="col-xs-4 text-right" style="padding-right: 0; color: #666; font-size: 0.9em;">
                            Avail: <strong id="modal-avail-qty" style="color: #333;">0</strong>
                        </div>
                    </div>

                    <div style="padding: 20px;">
                        <!-- Standard Buy / Offer Form (Hidden in Edit Mode) -->
                        <div id="standard-buy-offer-section">
                            <div style="display: flex; align-items: flex-start; gap: 15px;">
                                <!-- Qty -->
                                <div class="control-wrapper" style="width: 100px;">
                                    <input type="number" class="control-input qty text-center" id="modal-qty" value="1"
                                        min="1" style="width: 100%;">
                                    <span class="helper-text"
                                        style="display:block; text-align:center; margin-top: 4px;">Quantity</span>
                                </div>

                                <!-- Read-Only List Price (Buy Mode) -->
                                <div id="modal-buy-list-price-container" style="display:none; margin-top: 10px;">
                                    <span style="font-size: 0.95em; color: #555;">List: <strong
                                            id="modal-buy-list-price">$0.00</strong></span>
                                </div>

                                <!-- Optional Offer Price -->
                                <div class="control-wrapper" id="modal-offer-price-group"
                                    style="display:none; width: 140px;">
                                    <span class="input-prefix" style="left: 10px;">$</span>
                                    <input type="number" class="control-input price" id="modal-offer-price" step="0.01"
                                        style="padding-left: 20px; width: 100%;">
                                    <span class="helper-text static-list-price"
                                        style="display:block; margin-top: 4px;">List: <span
                                            id="modal-list-price">$0.00</span></span>
                                </div>

                                <!-- Total -->
                                <div style="margin-left: auto; text-align: right; align-self: center;">
                                    <div style="font-size: 0.85em; color: #8BA1A7; text-transform: uppercase;">Total
                                    </div>
                                    <div id="modal-total" style="font-weight: 600; font-size: 1.4em; color: #333;">$0.00
                                    </div>
                                    <div class="offer-feedback"
                                        style="display: flex; justify-content: flex-end; align-items: center; margin-top: 2px;">
                                        <span id="modal-feedback-badge" class="feedback-badge"
                                            style="display: none; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; font-weight: 600; margin-right: 4px;"></span>
                                        <span id="modal-feedback-caption" class="feedback-caption"
                                            style="font-size: 0.85em; color: #8BA1A7;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Offer Sections -->
                        <div id="edit-offer-sections" style="display:none;">

                            <!-- Current Offer (Always visible in edit mode) -->
                            <div class="panel panel-default" id="section-current-offer"
                                style="border: none; box-shadow: none; margin-bottom: 10px;">
                                <div class="panel-body"
                                    style="background-color: #f9f9f9; padding: 10px 15px; border-radius: 4px;">
                                    <div>
                                        <strong style="color: #555;">Current Offer</strong>
                                        <div style="font-size: 0.9em; margin-top: 3px; color: #666;">
                                            Qty: <strong id="eo-current-qty">0</strong> &nbsp;|&nbsp; Price: <strong
                                                id="eo-current-price">$0.00</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Counter Offer Details -->
                            <div class="panel" id="section-counter-offer"
                                style="display:none; margin-bottom: 10px; border: 1px solid #ce93d8;">
                                <div class="panel-heading"
                                    style="padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; background-color: #f3e5f5; color: #7b1fa2; border-bottom: none;">
                                    <div>
                                        <strong>Counter Offer Received</strong>
                                        <div style="font-size: 0.9em; margin-top: 3px; color: #6a1b9a;">
                                            Qty: <strong id="eo-counter-qty">0</strong> &nbsp;|&nbsp; Price: <strong
                                                id="eo-counter-price">$0.00</strong>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm"
                                        style="background-color: #9c27b0; color: white; border: none; padding: 5px 10px;"
                                        id="btn-accept-counter">ADD TO
                                        CART</button>
                                </div>
                            </div>

                            <!-- Accepted Offer Details -->
                            <div class="panel panel-success" id="section-accepted-offer"
                                style="display:none; margin-bottom: 10px;">
                                <div class="panel-heading"
                                    style="padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>Offer Accepted!</strong>
                                    </div>
                                    <button type="button" class="btn btn-success btn-sm" id="btn-accept-accepted">ADD TO
                                        CART</button>
                                </div>
                            </div>

                            <div class="panel panel-default" id="section-update-offer"
                                style="display:none; margin-bottom: 0;">
                                <div class="panel-body">
                                    <strong style="display:block; margin-bottom: 15px; color: #555;">Update
                                        Offer</strong>
                                    <div
                                        style="display: flex; align-items: flex-start; justify-content: space-between; gap: 15px;">

                                        <div style="display: flex; align-items: flex-start; gap: 15px;">
                                            <!-- Qty -->
                                            <div class="control-wrapper" style="width: 80px; margin-bottom: 0;">
                                                <input type="number" class="control-input qty text-center"
                                                    id="eo-update-qty" min="1" style="width: 100%;">
                                                <span class="helper-text" id="eo-update-avail"
                                                    style="display:block; text-align:center; margin-top: 4px;">Avail:
                                                    0</span>
                                            </div>

                                            <!-- Price -->
                                            <div class="control-wrapper" style="width: 120px; margin-bottom: 0;">
                                                <span class="input-prefix" style="left: 10px;">$</span>
                                                <input type="number" class="control-input price" id="eo-update-price"
                                                    step="0.01" style="padding-left: 20px; width: 100%;">
                                                <span class="helper-text" id="eo-update-list-price"
                                                    style="display:block; margin-top: 4px;">List: $0.00</span>
                                            </div>
                                        </div>

                                        <!-- Total & Feedback -->
                                        <div style="text-align: right; padding-top: 5px;">
                                            <div
                                                style="display: flex; align-items: baseline; justify-content: flex-end; gap: 6px;">
                                                <div
                                                    style="font-size: 0.85em; color: #8BA1A7; text-transform: uppercase;">
                                                    Total</div>
                                                <div id="eo-update-total"
                                                    style="font-weight: 600; font-size: 1em; color: #333;">$0.00</div>
                                            </div>
                                            <div class="offer-feedback"
                                                style="display: flex; justify-content: flex-end; align-items: center; margin-top: 2px;">
                                                <span id="eo-update-feedback-caption" class="feedback-caption"
                                                    style="font-size: 0.85em; color: #8BA1A7;"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="margin-top: 15px; text-align: right;">
                                        <button type="button" class="btn btn-primary btn-sm" id="btn-submit-update"
                                            style="padding: 5px 15px; font-weight: 600;">UPDATE OFFER</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="offer-disclaimer" class="alert alert-warning"
                            style="display:none; margin-top: 15px; font-size: 0.85em; margin-bottom:0; padding: 10px;">
                            <strong>Note:</strong> Offers are cleared daily at 11:00AM CT.
                        </div>
                    </div>
                    <div class="modal-footer"
                        style="display: flex; justify-content: space-between; align-items: center; border-top: none; padding-top:0;">
                        <div class="footer-left" style="flex: 1; text-align: left;">
                            <a href="#" id="modal-mode-toggle">Make an Offer</a>
                            <button type="button" class="btn btn-link text-muted" id="modal-cancel-offer"
                                style="display:none; padding: 0; text-decoration: none; font-size: 0.85em; font-weight: 600; letter-spacing: 0.5px;">CANCEL
                                OFFER</button>
                        </div>
                        <div class="footer-right" style="flex: 1; text-align: right;">
                            <button type="button" class="btn btn-primary" id="modal-submit-btn">ADD TO CART</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Card Template -->
    <script type="text/template" id="product-card-template">
        <div class="product-card">
            <!-- Header (Collapsed) -->
            <div class="card-header-row" data-id="<%= id %>">
                <div class="header-left">
                    <span class="material-icons chevron">chevron_right</span>
                    <span class="product-title"><%= model %></span> <!-- already includes capacity -->
                    <span class="chip grade"><%= grade %></span>
                    <span class="chip warehouse"><%= warehouse %></span>
                    
                    <span class="variant-badge"><%= variants.length %> Variant<%= variants.length !== 1 ? 's' : '' %></span>
                    <% if (varyingAttributes) { %>
                        <span class="variant-sneak-peek text-muted">Mixed: <%= varyingAttributes %></span>
                    <% } %>
                    <span class="total-qty">Qty: <strong><%= quantity %></strong></span>
                </div>
                <div class="header-right">


                    <span class="price-range"><%= priceRange %></span>
                    <button class="btn btn-link btn-pin" data-id="<%= id %>" style="padding: 0; color: #8BA1A7; margin-left: 10px;">
                        <span class="material-icons">bookmark_border</span>
                    </button>
                </div>
            </div>

            <!-- Body (Expanded) -->
            <div class="card-body" style="display: none;">
                <% _.each(variants, function(variant) { %>
                    <div class="variant-row">
                        <div class="variant-info">
                            <span class="variant-color" style="min-width: 120px;">
                                <%= variant.color %>
                                <% if (variant.network && variant.network !== 'N/A') { %>
                                    <span class="text-muted" style="font-size: 0.9em;">(<%= variant.network %><% if (variant.lockStatus) { %> - <%= variant.lockStatus %><% } %>)</span>
                                <% } else if (variant.lockStatus) { %>
                                    <span class="text-muted" style="font-size: 0.9em;">(<%= variant.lockStatus %>)</span>
                                <% } %>
                            </span>
                            <span class="variant-sku"><%= variant.sku %></span>
                            <span class="variant-qty text-muted">Qty: <%= variant.quantity %></span>
                        </div>
                        <div class="variant-actions">
                            <span class="variant-price">$<%= variant.price.toFixed(2) %></span>
                            <% if (variant.offerStatus && variant.offerStatus !== 'Draft') { 
                                // Map status to class
                                var statusClass = 'status-' + variant.offerStatus.toLowerCase().replace(' ', '-');
                                var qtyLabel = variant.submittedQty ? ': ' + variant.submittedQty : (variant.quantity ? ': ' + variant.quantity : '');
                            %>
                                <button class="btn btn-xs <%= statusClass %> btn-offer-status" data-sku="<%= variant.sku %>" data-status="<%= variant.offerStatus %>">
                                    <%= variant.offerStatus.toUpperCase() %><%= qtyLabel %>
                                </button>
                            <% } else { %>
                                <button class="btn btn-default btn-offer" data-id="<%= id %>" data-sku="<%= variant.sku %>">OFFER</button>
                                <button class="btn btn-primary btn-buy" data-id="<%= id %>" data-sku="<%= variant.sku %>">BUY</button>
                                <button class="btn btn-link btn-pin-variant" data-sku="<%= variant.sku %>" style="padding: 0; color: #8BA1A7; margin-left: 5px;">
                                    <span class="material-icons">bookmark_border</span>
                                </button>
                            <% } %>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>
    </script>



    <!-- Offer Drawer (Right Side) -->
    <div id="offer-drawer" class="offer-drawer">
        <div class="drawer-header">
            <div class="drawer-title">
                <span class="material-icons">grid_view</span>
                Offer Worksheet <span style="font-size: 10px; color: #ccc; margin-left: 5px;">v2.7</span>
            </div>
            <div class="drawer-view-tabs">
                <button class="view-tab active" data-view="pinned">Pinned <span
                        class="badge tab-badge">0</span></button>
                <button class="view-tab" data-view="active">Active <span class="badge tab-badge">0</span></button>
            </div>
            <div class="drawer-actions">
                <div class="overflow-menu-container">
                    <button class="drawer-action-btn" id="drawer-menu-btn">
                        <span class="material-icons">more_vert</span>
                    </button>
                    <div class="overflow-menu" id="drawer-overflow-menu">
                        <div class="overflow-menu-item btn-generate-xlsx">
                            <span class="material-icons">file_download</span>
                            Export to XLSX
                        </div>
                        <div class="overflow-menu-item btn-reset-demo-data">
                            <span class="material-icons">refresh</span>
                            Reset Demo Data
                        </div>
                    </div>
                </div>
                <button class="drawer-action-btn drawer-close-btn">
                    <span class="material-icons">close</span>
                </button>
            </div>
        </div>
        <div class="drawer-body">
            <div class="drawer-body-search-container"
                style="padding: 10px 15px; position: relative; background: transparent;">
                <input type="text" class="form-control drawer-search-input" placeholder="Search variants..."
                    style="background: white;">
                <span class="material-icons drawer-search-clear"
                    style="display: none; position: absolute; right: 25px; top: 16px; font-size: 16px; color: #999; cursor: pointer;">close</span>
            </div>
            <div class="offer-item-list">
                <!-- Items will be injected here via JS Template -->
                <div class="text-center text-muted" style="padding: 20px;">
                    No items selected.
                </div>
            </div>
        </div>
        <div class="drawer-footer">
            <button class="btn-place-offer" disabled>
                <span class="material-icons">shopping_cart_checkout</span>
                Place Offers
                <span class="badge count-badge" style="display:none">0</span>
            </button>
            <div class="offer-summary">
                <span>Total</span>
                <span class="offer-total-amount">$0.00</span>
            </div>
        </div>
    </div>

    <script type="text/template" id="offer-group-template">
        <div class="offer-group" data-group-key="<%= groupKey %>">
            <div class="offer-group-header">
                <div class="header-left">
                    <span class="product-title"><%= manufacturer %> <%= model %></span>
                    <% _.each(grades, function(g) { %>
                        <span class="chip grade"><%= g %></span>
                    <% }); %>
                    <% _.each(warehouses, function(w) { %>
                        <span class="chip warehouse"><%= w %></span>
                    <% }); %>
                </div>
                <!-- Optional: Add remove group button here if needed -->
                <!-- <div class="header-right">...</div> -->
            </div>
            <div class="offer-group-variants">
                <!-- Variants injected here -->
            </div>
        </div>
    </script>

    <!-- Variant Row Template -->
    <script type="text/template" id="offer-variant-template">

        <div class="offer-variant-row" data-sku="<%= sku %>">
            <!-- Left: Info -->
            <!-- Left Column: Info -->
            <div class="variant-info-col">
                <div class="variant-desc-row">
                    <% if (hasUnsubmittedChanges) { %>
                        <div class="unsubmitted-dot" title="Has Unsubmitted Edits"></div>
                    <% } else { %>
                        <div class="unsubmitted-dot" style="display: none;" title="Has Unsubmitted Edits"></div>
                    <% } %>
                    <span class="variant-color">
                        <%= description %>
                        <% if (typeof lockStatus !== 'undefined' && lockStatus) { %>
                            <span class="text-muted" style="font-size: 0.9em; font-weight: normal;">(<%= lockStatus %>)</span>
                        <% } %>
                    </span>
                </div>
                <div class="variant-meta-row">
                    <span class="variant-sku"><%= sku %></span>
                    <% if (status === 'Countered') { %>
                        <span class="variant-status-badge status-countered" title="Counter Offer">
                            COUNTERED: <%= counterQty %> @ $<%= counterPrice.toFixed(2) %>
                            <a href="#" class="add-to-cart-action action-link" data-sku="<%= sku %>" data-action-type="counter">ADD TO CART</a>
                        </span>
                    <% } else if (status === 'Accepted') { %>
                        <span class="variant-status-badge status-accepted">
                            ACCEPTED: <%= submittedQty %> @ $<%= submittedPrice.toFixed(2) %>
                            <a href="#" class="add-to-cart-action action-link" data-sku="<%= sku %>" data-action-type="accepted">ADD TO CART</a>
                        </span>
                    <% } else { %>
                        <span class="variant-status-badge status-<%= status ? status.toLowerCase().replace(' ', '-') : 'draft' %>" 
                              <% if ((!status || status === 'Draft') && (!qty || !price)) { %>style="display: none;"<% } %>>
                            <%= status || 'Draft' %>
                        </span>
                    <% } %>
                </div>
            </div>

            <!-- Right: Controls -->
            <div class="variant-offer-controls-row">
                 <!-- Qty Input -->
                 <div class="control-wrapper">
                    <span class="edited-label" style="display: none;">Edited</span>
                    <input type="number" class="control-input qty" value="<%= qty %>" min="1" max="<%= availableQty %>" data-submitted-val="<%= submittedQty %>" <% if (status === 'In Cart') { %>disabled<% } %>>
                    <span class="helper-text">Avail: <%= availableQty %></span>
                </div>

                <!-- Price Input -->
                
                <div class="input-container control-wrapper">
                    <span class="edited-label" style="display: none;">Edited</span>
                    <span class="input-prefix">$</span>
                    <input type="number" class="control-input price" value="<%= price %>" placeholder="0.00" step="0.01" data-submitted-val="<%= submittedPrice %>" <% if (status === 'In Cart') { %>disabled<% } %>>
                    <span class="helper-text static-list-price">List: $<%= listPrice %></span>
                </div>
                
                <!-- Item Total & Feedback -->
                <div class="total-wrapper">
                    <span class="item-total">
                        <!-- Populated by JS -->
                    </span>
                    <div class="offer-feedback">
                        <span class="feedback-badge"></span>
                        <span class="feedback-caption"></span>
                    </div>
                </div>

                <!-- Actions -->
                <% if (!status || status === 'Draft') { %>
                    <% if (qty > 0 && price > 0) { %>
                        <button class="offer-item-clear-btn offer-item-clear text-danger" title="Clear Inputs" style="background: none; border: none; padding: 4px; display: flex; align-items: center;">
                            <span class="material-icons">backspace</span>
                        </button>
                    <% } else { %>
                        <button class="offer-item-unpin-btn offer-item-unpin" title="Unpin Item" style="color: #0070B9;">
                            <span class="material-icons">bookmark</span>
                        </button>
                    <% } %>
                <% } else { %>
                    <div class="variant-menu-container">
                        <button class="variant-menu-btn" title="More Actions">
                            <span class="material-icons">more_vert</span>
                        </button>
                        <div class="variant-overflow-menu">
                            <% 
                                var cartLabel = 'Add to Cart';
                                var cartPrice = 0;
                                var actionType = 'list'; // default to list price add

                                if (status === 'Pending' || status === 'Rejected') {
                                    cartLabel = 'Add to Cart @ $' + listPrice;
                                    cartPrice = listPrice;
                                    actionType = 'list';
                                } else if (status === 'Countered') {
                                    cartLabel = 'Add to Cart @ $' + counterPrice.toFixed(2);
                                    cartPrice = counterPrice;
                                    actionType = 'counter';
                                } else if (status === 'Accepted') {
                                    cartLabel = 'Add to Cart @ $' + submittedPrice.toFixed(2);
                                    cartPrice = submittedPrice;
                                    actionType = 'accepted';
                                } else if (status === 'In Cart') {
                                    cartLabel = 'View in Cart'; // Fallback or keep as is? User didn't specify In Cart. 
                                    // Actually "View in Cart" implies it's already there. 
                                    // User said "change View in Cart ... to Add to Cart ... when status is ...".
                                    // If status is "In Cart", we probably keep "View in Cart".
                                }
                            %>

                            <% if (status === 'In Cart') { %>
                                <div class="variant-menu-item action-view-cart">
                                    View in Cart
                                </div>
                            <% } else { %>
                                <div class="variant-menu-item action-add-to-cart-menu" data-action-type="<%= actionType %>">
                                    <%= cartLabel %>
                                </div>
                            <% } %>
                            <div class="variant-menu-item action-cancel-offer danger">
                                Cancel Offer
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </script>

    <!-- Sticky Offer Bar -->
    <div id="offer-bar" class="offer-bar">
        <div class="container-fluid">
            <div class="offer-bar-content">

                <!-- OFFERS SECTION -->
                <div class="fab-section">
                    <span class="fab-section-title">OFFERS</span>
                    <div class="offer-bar-actions">
                        <button class="btn btn-dark btn-sm btn-view-pinned">
                            Pinned <span class="badge badge-light pinned-count">0</span>
                        </button>
                        <button class="btn btn-dark btn-sm btn-view-active">
                            Active <span class="badge badge-success active-count">0</span>
                        </button>
                    </div>
                </div>

                <div class="fab-divider"></div>

                <!-- CART SECTION -->
                <div class="fab-section" style="flex-grow: 1;">
                    <span class="fab-section-title">CART</span>
                    <div class="offer-bar-actions">
                        <button class="btn btn-dark btn-sm btn-cart">
                            Ready <span class="badge badge-light">0</span>
                        </button>
                    </div>
                </div>

                <!-- OVERFLOW MENU (FAR RIGHT) -->
                <div class="offer-bar-menu-container">
                    <button class="btn btn-icon offer-bar-menu-btn">
                        <span class="material-icons">more_vert</span>
                    </button>
                    <div class="offer-bar-menu">
                        <div class="menu-item action-import">
                            <span class="material-icons">file_upload</span> Import
                        </div>
                        <div class="menu-item action-export">
                            <span class="material-icons">file_download</span> Export
                        </div>
                        <div class="menu-item action-clear-pinned">
                            <span class="material-icons">close</span> Clear Pinned
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.1/underscore-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.4.0/backbone-min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <!-- SheetJS for XLSX -->
    <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- App Logic -->
    <script src="../assets/mock-data.js?v=2.0"></script>
    <script src="v2.js?v=2.0"></script>
    <script src="../assets/nav.js?v=2.0"></script>

</body>

</html>